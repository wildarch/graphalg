// RUN: split-file %s %t
// RUN: graphalg-translate --import-graphalg %t/input.gr > %t/parsed.mlir
// RUN: graphalg-opt --graphalg-to-core-pipeline --graphalg-set-dimensions='func=PR args=50x50' %t/parsed.mlir > %t/exec.mlir
// RUN: graphalg-exec %t/exec.mlir PR %t/graph.m | diff - %t/output.m

//--- graph.m
0 18
0 20
0 21
0 26
0 30
0 36
0 44
0 47
1 2
1 19
1 38
1 45
2 5
2 9
2 31
2 40
2 44
3 14
4 14
4 15
4 17
4 27
4 46
5 48
6 5
6 26
6 42
6 45
7 4
7 20
7 28
7 29
7 31
7 42
8 15
8 17
8 20
8 27
8 29
8 34
8 39
9 8
9 12
9 27
9 28
9 32
10 2
10 38
11 46
11 49
12 6
12 11
12 16
12 31
12 47
13 3
13 19
13 20
13 34
13 37
13 39
14 7
14 23
14 30
14 34
14 43
16 4
16 8
16 10
16 15
16 25
16 36
17 0
17 11
17 27
17 29
17 43
17 44
17 46
17 49
18 9
18 10
18 12
18 26
18 37
19 14
19 24
20 21
20 26
20 30
20 31
20 39
21 18
21 25
21 26
21 30
22 21
22 34
22 35
22 37
22 39
22 45
22 46
23 8
23 12
23 14
23 33
23 35
23 49
24 7
24 23
24 29
24 33
24 40
24 46
25 6
25 30
25 36
25 39
25 43
25 46
26 30
26 32
26 42
27 7
27 31
27 41
27 44
28 0
28 1
28 11
28 13
28 15
28 18
28 19
28 35
29 8
29 23
29 33
29 43
30 10
30 16
30 31
30 38
30 45
30 46
31 1
31 27
31 28
31 29
31 30
32 6
32 7
32 8
32 9
32 31
32 33
32 36
33 25
33 47
34 2
34 9
34 16
34 23
34 25
34 27
34 32
34 40
35 19
35 20
35 28
35 31
35 45
36 0
36 4
36 8
36 12
36 22
36 23
37 1
37 21
37 49
38 5
38 7
38 19
38 27
38 29
38 46
38 47
39 4
39 6
39 7
39 10
39 32
39 33
39 36
39 48
40 23
40 42
42 0
42 1
42 10
42 14
42 16
42 28
42 37
42 46
43 10
43 12
43 14
44 4
44 10
44 11
44 20
44 23
45 22
45 23
45 25
45 30
45 35
45 40
46 7
46 13
46 15
46 27
46 28
46 33
46 34
46 39
46 41
46 45
46 49
47 7
47 18
47 29
47 34
47 37
47 42
47 49
48 6
48 7
48 16
48 17
49 3
49 27
49 46

//--- input.gr
func withDamping(degree:int, damping:real) -> real {
    return cast<real>(degree) / damping;
}

func PR(graph: Matrix<s1, s1, bool>) -> Vector<s1, real> {
    damping = real(0.85);
    iterations = int(10);
    n = graph.nrows;
    teleport = (real(1.0) - damping) / cast<real>(n);
    rdiff = real(1.0);

    d_out = reduceRows(cast<int>(graph));

    d = apply(withDamping, d_out, damping);

    connected = reduceRows(graph);
    sinks = Vector<bool>(n);
    sinks<!connected>[:] = bool(true);

    pr = Vector<real>(n);
    pr[:] = real(1.0) / cast<real>(n);

    for i in int(0):iterations {
        sink_pr = Vector<real>(n);
        sink_pr<sinks> = pr;
        redist = (damping / cast<real>(n)) * reduce(sink_pr);

        w = pr (./) d;

        pr[:] = teleport + redist;
        pr += cast<real>(graph).T * w;
    }

    return pr;
}

//--- output.m
0 0 0.01230534094758623 : f64
1 0 0.018516181522062729 : f64
2 0 0.020895136881158929 : f64
3 0 0.011765870574152695 : f64
4 0 0.018121238194574035 : f64
5 0 0.013705773824524462 : f64
6 0 0.017670623870377176 : f64
7 0 0.034001858634696222 : f64
8 0 0.022537524868317615 : f64
9 0 0.013155978428682795 : f64
10 0 0.026543837535447753 : f64
11 0 0.013863692220573409 : f64
12 0 0.020308280277015207 : f64
13 0 0.0090253001991132276 : f64
14 0 0.036728148219167797 : f64
15 0 0.017720288046999717 : f64
16 0 0.020311124242889722 : f64
17 0 0.012985083830940908 : f64
18 0 0.012671528168551244 : f64
19 0 0.016796254276931422 : f64
20 0 0.019116343815342551 : f64
21 0 0.012898564744112313 : f64
22 0 0.0088246950035254165 : f64
23 0 0.032901172333799425 : f64
24 0 0.010670006289798655 : f64
25 0 0.023695165871781491 : f64
26 0 0.016739218972743143 : f64
27 0 0.033753751747645916 : f64
28 0 0.024650774747917562 : f64
29 0 0.025260433463596098 : f64
30 0 0.034319570117167325 : f64
31 0 0.03497312117260596 : f64
32 0 0.014581245911134681 : f64
33 0 0.021640519041231262 : f64
34 0 0.020208545140309786 : f64
35 0 0.01508474645672528 : f64
36 0 0.014767733801542185 : f64
37 0 0.013190574756367019 : f64
38 0 0.023610200113096308 : f64
39 0 0.018100026050154192 : f64
40 0 0.013943377945606818 : f64
41 0 0.013578873909238174 : f64
42 0 0.025243808562124735 : f64
43 0 0.019880438588128289 : f64
44 0 0.016944275853068323 : f64
45 0 0.022593879345991899 : f64
46 0 0.037191495013145746 : f64
47 0 0.020356317190339146 : f64
48 0 0.017103953238555451 : f64
49 0 0.024548106039441527 : f64
